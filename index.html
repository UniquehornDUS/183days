<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>183‑Tage‑Checker</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b0c10" />
  <link rel="manifest" href="app.webmanifest" />
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />

  <style>
    :root{
      --bg:#0b0c10; --panel:#12141a; --muted:#2a2e39; --text:#e8ebf1; --soft:#b9c0cf;
      --accent:#38bdf8; --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
      --shadow:0 6px 24px rgba(0,0,0,.35); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding: max(24px, env(safe-area-inset-top)) 24px 24px;}
    header{display:flex;gap:18px;align-items:flex-start;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:42px;height:42px;border-radius:14px;
      background:radial-gradient(120% 120% at 70% 30%, #7dd3fc, #38bdf8 60%, #0ea5e9);
      box-shadow:0 6px 24px rgba(2,132,199,.35), inset 0 1px 0 rgba(255,255,255,.2);}
    h1{font-size:clamp(1.2rem,1.2rem + 1.2vw,1.9rem);margin:0;letter-spacing:.2px}
    .sub{color:var(--soft);font-size:.95rem}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:700;transform:translateY(2px)}
    .ok{background:rgba(34,197,94,.12);color:#4ade80;border:1px solid rgba(34,197,94,.25)}
    .warn{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.25)}
    .bad{background:rgba(239,68,68,.14);color:#fca5a5;border:1px solid rgba(239,68,68,.28)}
    .panel{background:var(--panel);border:1px solid #1b1f29;border-radius:var(--radius);box-shadow:var(--shadow)}
    .controls{display:grid;gap:14px;padding:16px;grid-template-columns:repeat(12,1fr);align-items:end}
    .control{display:flex;flex-direction:column;gap:8px;grid-column:span 12}
    .control.half{grid-column:span 6}.control.third{grid-column:span 4}.control.two{grid-column:span 2}
    label{color:var(--soft);font-weight:600;font-size:.9rem}
    input[type="text"],input[type="date"],input[type="number"]{
      background:#0f1117;border:1px solid #232838;color:var(--text);border-radius:14px;padding:14px 16px;outline:none;
      transition:border-color .2s, box-shadow .2s; font-variant-numeric: tabular-nums;}
    input:focus{border-color:#3ec8ff;box-shadow:0 0 0 3px rgba(62,200,255,.15)}
    input[type="number"]{-moz-appearance:textfield}
    input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    .btn{background:linear-gradient(180deg,#3ec8ff,#0ea5e9 60%,#0284c7);color:white;border:none;border-radius:14px;padding:14px 16px;
      font-weight:700;cursor:pointer;transition:transform .04s ease,filter .2s ease}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
    .btn.muted{background:#1f2330;border:1px solid #2a3144;color:#c6cfde}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr);margin-top:16px}
    .card{padding:18px;border-radius:var(--radius);background:var(--panel);border:1px solid #1b1f29}
    .span-6{grid-column:span 6}.span-12{grid-column:span 12}
    .metrics{display:flex;gap:18px;align-items:stretch;flex-wrap:wrap}
    .kpi{flex:1 1 240px;background:#0f1117;border:1px solid #232838;border-radius:14px;padding:16px}
    .kpi .val{font-size:2rem;font-weight:800;letter-spacing:.5px}
    .kpi .hint{color:var(--soft)}
    .donut{--fill:0deg;--ring:var(--accent);--track:#1e2433;--hole:#0b0d14;
      width:200px;aspect-ratio:1;border-radius:50%;background:conic-gradient(var(--ring) var(--fill),var(--track) 0);
      position:relative;margin:auto}
    .donut::before{content:"";position:absolute;inset:12px;background:var(--hole);border-radius:50%;box-shadow:inset 0 0 0 2px #1b2231}
    .donut .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;gap:2px}
    .donut .big{font-size:2.4rem;font-weight:900;letter-spacing:.3px}
    .donut .small{font-size:.9rem;color:var(--soft)}
    .timeline{background:#0f1117;border:1px solid #232838;border-radius:14px;padding:14px}
    .timeline .legend{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;color:var(--soft);font-size:.9rem}
    .chip{display:inline-flex;align-items:center;gap:8px}
    .swatch{width:14px;height:10px;border-radius:2px;background:var(--accent)}
    .swatch.gray{background:#2a3144}
    svg{width:100%;height:auto;display:block}
    table{width:100%;border-collapse:collapse;border-spacing:0}
    th,td{padding:12px 10px;text-align:left;border-bottom:1px solid #1f2533;font-variant-numeric:tabular-nums}
    tr:hover td{background:#0e1119}
    #staysTable thead th{position:sticky;top:0;background:#10131a;z-index:1}
    #staysTable tbody tr:nth-child(odd) td{background:#0f131b}
    #staysTable td:nth-child(4), #staysTable td:nth-child(5){text-align:right}
    .link{color:#9cc9ff;cursor:pointer}
    .footer{color:#8b94a7;font-size:.9rem;margin-top:18px}
    @media (max-width:860px){.control.half,.control.third{grid-column:span 12}.span-6{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>183‑Tage‑Checker</h1>
          <div class="sub">Rolling‑Window‑Zähler für die letzten 365 Tage – klar, plakativ, lokal gespeichert.</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="installBtn" class="btn muted" style="display:none">Installieren</button>
        <span class="badge ok" id="statusBadge">Bereit</span>
      </div>
    </header>

    <section class="panel controls">
      <div class="control third">
        <label for="country">Land</label>
        <input id="country" type="text" placeholder="z. B. Deutschland, Spanien, UAE" />
      </div>
      <div class="control third">
        <label for="refDate">Stichtag (heute)</label>
        <input id="refDate" type="date" />
      </div>
      <div class="control two">
        <label for="threshold">Grenzwert</label>
        <input id="threshold" type="number" min="1" value="183" />
      </div>
      <div class="control">
        <label>Abreisetag mitzählen?</label>
        <div class="switch"><input id="countDeparture" type="checkbox" checked><span>Ja</span></div>
      </div>
      <div class="control half">
        <label>Aufenthalt hinzufügen</label>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="from" type="date" />
          <input id="to" type="date" />
          <button id="add" class="btn">Zeitraum hinzufügen</button>
          <button id="clearCountry" class="btn muted" title="Alle Einträge für dieses Land entfernen">Alle löschen</button>
        </div>
      </div>
    </section>

    <section class="grid">
      <div class="card span-6">
        <div class="donut" id="donut" aria-label="Fortschritt Richtung 183 Tage" style="--fill:0deg">
          <div class="label">
            <div class="big" id="usedDays">0</div>
            <div class="small"><span id="countryLabel">–</span><span> • genutzt</span></div>
            <div class="small" id="overInfo"></div>
          </div>
        </div>
        <div class="metrics" style="margin-top:16px">
          <div class="kpi">
            <div class="hint">Tage noch übrig bis Grenzwert</div>
            <div class="val" id="daysLeft">183</div>
          </div>
          <div class="kpi">
            <div class="hint">Zählfenster</div>
            <div class="val" id="windowRange">–</div>
          </div>
          <div class="kpi">
            <div class="hint">Grenzwert</div>
            <div class="val" id="thresholdOut">183</div>
          </div>
        </div>
      </div>

      <div class="card span-6">
        <div class="timeline">
          <div class="legend">
            <span class="chip"><span class="swatch"></span> gezählte Tage (letzte 365)</span>
            <span class="chip"><span class="swatch gray"></span> übriges Fenster</span>
          </div>
          <div id="timelineSvg"></div>
        </div>
      </div>

      <div class="card span-12">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <h3 style="margin:0;font-size:1.05rem">Aufenthalte <span id="listTitle" style="color:var(--soft)"></span></h3>
          <div style="color:var(--soft);font-size:.9rem">Tipp: Du kannst mehrere Zeiträume pro Land erfassen.</div>
        </div>
        <div style="overflow:auto">
          <table id="staysTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Von</th>
                <th>Bis</th>
                <th>Tage gesamt</th>
                <th>davon gezählt (365d)</th>
                <th class="actions">Aktion</th>
              </tr>
            </thead>
            <tbody id="staysBody"></tbody>
          </table>
        </div>
        <div class="footer">
          Hinweis: Länder zählen Aufenthaltstage teils unterschiedlich (z. B. ob der Abreisetag zählt). Diese App rechnet standardmäßig
          <strong>inklusive An‑ und Abreisetag</strong>. Du kannst das oben anpassen. Dies ist keine Rechtsberatung.
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------- Utilities ----------
    const msDay = 24*60*60*1000;
    const pad = (n)=> String(n).padStart(2,'0');
    const toUTC = (str)=>{ if(!str) return null; const [y,m,d]=str.split('-').map(Number); if(!y||!m||!d) return null; return new Date(Date.UTC(y,m-1,d)); };
    const fromDayIndex = (idx)=> new Date(idx*msDay);
    const dayIndex = (date)=> Math.floor(date.getTime()/msDay);
    const iso = (date)=> `${date.getUTCFullYear()}-${pad(date.getUTCMonth()+1)}-${pad(date.getUTCDate())}`;
    const todayUTC = ()=>{ const now=new Date(); return new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate())); };
    const clampRangeToWindow = (s,e,ws,we)=>{ const a=Math.max(s,ws), b=Math.min(e,we); return a<=b?[a,b]:null; };
    const mergeIntervals = (ivs)=>{ if(!ivs.length) return []; ivs.sort((a,b)=>a[0]-b[0]); const out=[ivs[0].slice()]; for(let i=1;i<ivs.length;i++){const[s,e]=ivs[i];const last=out[out.length-1]; if(s<=last[1]+1) last[1]=Math.max(last[1],e); else out.push([s,e]);} return out; };
    const fmtDE = (isoStr)=>{ const [y,m,d]= (isoStr||'').split('-'); return (y&&m&&d)?`${d}.${m}.${y}`:isoStr; };

    // ---------- State ----------
    const stateKey = 'days183.state.v1';
    let state = { selectedCountry:'', threshold:183, refDate:null, countDeparture:true, staysByCountry:{} };

    function loadState(){ try{ const raw=localStorage.getItem(stateKey); if(raw){ state=Object.assign(state, JSON.parse(raw)); } }catch(e){ console.warn('State load failed', e); } }
    function saveState(){ localStorage.setItem(stateKey, JSON.stringify(state)); }

    // ---------- Core ----------
    function compute(country){
      const threshold = Number(state.threshold)||183;
      const ref = toUTC(state.refDate) || todayUTC();
      const wEnd = dayIndex(ref), wStart = wEnd - 364;
      const countDeparture = !!state.countDeparture;

      const stays = (state.staysByCountry[country]||[])
        .map(s=>{ const a=toUTC(s.from), b=toUTC(s.to); if(!a||!b) return null;
          let si=dayIndex(a), ei=dayIndex(b); if(!countDeparture) ei-=1; if(ei<si) [si,ei]=[ei,si]; return [si,ei]; })
        .filter(Boolean);

      const perStayCount = stays.map(([s,e])=>{ const cut=clampRangeToWindow(s,e,wStart,wEnd); return cut? (cut[1]-cut[0]+1) : 0; });
      const intersected = stays.map(([s,e])=>clampRangeToWindow(s,e,wStart,wEnd)).filter(Boolean);
      const merged = mergeIntervals(intersected);
      const used = merged.reduce((acc,[s,e])=> acc + (e - s + 1), 0);
      const left = Math.max(threshold - used, 0);
      const over = Math.max(used - threshold, 0);

      return { wStart,wEnd,threshold,used,left,over,merged,perStayCount,
        winStartIso: iso(fromDayIndex(wStart)), winEndIso: iso(fromDayIndex(wEnd)) };
    }

    const el = (id)=> document.getElementById(id);

    function init(){
      loadState();
      if(!state.refDate) state.refDate = iso(todayUTC());
      el('country').value = state.selectedCountry || '';
      el('refDate').value = state.refDate;
      el('threshold').value = state.threshold;
      el('countDeparture').checked = state.countDeparture;

      el('add').addEventListener('click', onAdd);
      el('clearCountry').addEventListener('click', onClearCountry);
      el('country').addEventListener('input', ()=>{ state.selectedCountry = el('country').value.trim(); saveState(); render(); });
      el('refDate').addEventListener('change', ()=>{ state.refDate = el('refDate').value || iso(todayUTC()); saveState(); render(); });
      el('threshold').addEventListener('input', ()=>{ const v=Math.max(1, Number(el('threshold').value||183)); state.threshold=v; saveState(); render(); });
      el('countDeparture').addEventListener('change', ()=>{ state.countDeparture = el('countDeparture').checked; saveState(); render(); });

      if(!state.selectedCountry){ state.selectedCountry = '–'; }
      setupPWA();
      render();
    }

    function onAdd(){
      const country = (el('country').value||'–').trim(); state.selectedCountry = country || '–';
      const from=el('from').value, to=el('to').value;
      if(!from || !to){ flash('Bitte gib Start‑ und Enddatum ein.', 'warn'); return; }
      const a=toUTC(from), b=toUTC(to); if(!a||!b){ flash('Ungültiges Datum.', 'warn'); return; }
      state.staysByCountry[country] ??= []; state.staysByCountry[country].push({from,to});
      saveState(); el('from').value=''; el('to').value=''; render(); flash('Aufenthalt hinzugefügt.','ok');
    }
    function onDelete(country, idx){ state.staysByCountry[country].splice(idx,1); saveState(); render(); }
    function onClearCountry(){
      const c=(el('country').value||'–').trim();
      if(!state.staysByCountry[c] || state.staysByCountry[c].length===0){ flash('Keine Einträge für dieses Land.','warn'); return; }
      if(confirm(`Alle Aufenthalte für „${c}“ löschen?`)){ state.staysByCountry[c]=[]; saveState(); render(); }
    }

    function flash(msg, mode='ok'){
      const badge=el('statusBadge');
      badge.textContent = msg;
      badge.className = 'badge ' + (mode==='ok'?'ok':(mode==='warn'?'warn':'bad'));
      setTimeout(()=> updateStatusBadge(), 1600);
    }

    function updateStatusBadge(){
      const country = (state.selectedCountry||'–').trim() || '–';
      const {used,threshold} = compute(country);
      const badge=el('statusBadge');
      if(used >= threshold){ badge.textContent='Grenze erreicht'; badge.className='badge bad'; }
      else if(used >= Math.max(1, threshold - 33)){ badge.textContent='Achtung'; badge.className='badge warn'; }
      else{ badge.textContent='Bereit'; badge.className='badge ok'; }
    }

    function render(){
      const country = (state.selectedCountry||'–').trim() || '–';
      el('countryLabel').textContent = country;
      el('listTitle').textContent = `(${country})`;

      const { wStart, wEnd, threshold, used, left, over, merged, perStayCount, winStartIso, winEndIso } = compute(country);

      // KPIs
      el('usedDays').textContent = used;
      el('daysLeft').textContent = left;
      el('thresholdOut').textContent = threshold;
      el('windowRange').textContent = `${winStartIso} – ${winEndIso}`;

      // Donut
      const donut=el('donut'); const ratio=threshold>0?(used/threshold):0; const deg=Math.min(ratio,1)*360;
      donut.style.setProperty('--fill',deg+'deg'); let ringColor='var(--accent)';
      if(ratio>=1){ ringColor='var(--danger)'; } else if(ratio>=0.82){ ringColor='var(--warn)'; }
      donut.style.setProperty('--ring',ringColor);
      el('overInfo').textContent = over>0 ? `Über Grenze: +${over} Tag${over===1?'':'e'}` : '';

      // Tabelle
      const tbody=el('staysBody'); tbody.innerHTML='';
      const list=state.staysByCountry[country]||[];
      list.forEach((s,i)=>{
        const a=toUTC(s.from), b=toUTC(s.to); let total=0;
        if(a && b){ let si=dayIndex(a), ei=dayIndex(b); if(!state.countDeparture) ei-=1; if(ei<si) [si,ei]=[ei,si]; total=(ei-si+1); if(total<0) total=0; }
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${i+1}</td>
          <td>${fmtDE(s.from)}</td>
          <td>${fmtDE(s.to)}</td>
          <td>${total}</td>
          <td>${perStayCount[i]||0}</td>
          <td class="actions"><span class="link" data-i="${i}">löschen</span></td>`;
        tr.querySelector('.link').addEventListener('click',()=>onDelete(country,i));
        tbody.appendChild(tr);
      });
      if(list.length===0){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td colspan="6" style="color:var(--soft);text-align:center;padding:20px">Noch keine Aufenthalte. Füge oben einen Zeitraum hinzu.</td>`;
        tbody.appendChild(tr);
      }

      // Timeline
      renderTimeline(wStart,wEnd,merged);

      // Status
      updateStatusBadge();
    }

    function renderTimeline(wStart,wEnd,merged){
      const days=(wEnd-wStart+1), width=1000, height=74, padX=20, trackY=36, trackH=16;
      const scale=(di)=>{ const t=(di-wStart)/(days-1); return padX + t*(width-padX*2); };
      const monthTicks=[]; const startDate=fromDayIndex(wStart), endDate=fromDayIndex(wEnd);
      let d=new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), 1));
      if(d<startDate) d=new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth()+1, 1));
      while(d<=endDate){ monthTicks.push(new Date(d)); d=new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth()+1, 1)); }

      let svg=`<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" aria-label="Timeline der letzten 365 Tage">
        <defs><linearGradient id="grad" x1="0" x2="1" y1="0" y2="0">
          <stop offset="0%" stop-color="#2a3144" /><stop offset="100%" stop-color="#2a3144" />
        </linearGradient></defs>
        <rect x="${padX}" y="${trackY}" width="${width-padX*2}" height="${trackH}" rx="8" fill="url(#grad)" />`;

      merged.forEach(([s,e])=>{ const x=scale(s), x2=scale(e), w=Math.max(2,x2-x);
        svg+=`<rect x="${x}" y="${trackY}" width="${w}" height="${trackH}" rx="8" fill="#38bdf8" />`; });

      monthTicks.forEach(m=>{ const idx=dayIndex(m), x=scale(Math.max(wStart,Math.min(wEnd,idx)));
        const label=m.toLocaleString('de-DE',{month:'short'});
        svg+=`<line x1="${x}" x2="${x}" y1="${trackY-10}" y2="${trackY+trackH+10}" stroke="#202636" stroke-width="1"/>`;
        svg+=`<text x="${x+4}" y="${trackY-12}" font-size="10" font-weight="700" fill="#9aa6bf">${label}</text>`; });

      svg+=`<text x="${padX}" y="${trackY+trackH+28}" font-size="11" fill="#8b94a7">${iso(fromDayIndex(wStart))}</text>
             <text x="${width-padX-100}" y="${trackY+trackH+28}" font-size="11" fill="#8b94a7">${iso(fromDayIndex(wEnd))}</text></svg>`;
      document.getElementById('timelineSvg').innerHTML = svg;
    }

    // ---------- PWA ----------
    function setupPWA(){
      const btn=el('installBtn');
      if('serviceWorker' in navigator){
        window.addEventListener('load', ()=>{
          navigator.serviceWorker.register('./sw.js',{scope:'./'}).catch(err=>console.warn('SW reg fail',err));
        });
      }
      let deferredPrompt=null;
      window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; btn.style.display='inline-flex'; });
      btn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; if(outcome==='accepted'){ flash('App wird installiert …','ok'); } btn.style.display='none'; deferredPrompt=null; });
      window.addEventListener('appinstalled', ()=> flash('App installiert. 🎉','ok'));

      function updateInstallState(){
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        if(isStandalone){ el('statusBadge').textContent='Installiert'; el('statusBadge').className='badge ok'; btn.style.display='none'; }
      }
      updateInstallState();
      window.matchMedia('(display-mode: standalone)').addEventListener('change', updateInstallState);

      function updateOnline(){
        const b=el('statusBadge');
        if(navigator.onLine){ /* nix, Status regelt updateStatusBadge */ } else { b.textContent='Offline'; b.className='badge warn'; }
      }
      window.addEventListener('online', updateOnline);
      window.addEventListener('offline', updateOnline);
      updateOnline();
    }

    // Boot
    init();
  </script>
</body>
</html>
